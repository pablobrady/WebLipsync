<!DOCTYPE html>
<html>
<head>
<title>Anim Practice</title>

<style>
.surface {
  background: rgba(0, 0, 0, 0.2) url("images/blur_riverbg.jpg") top left no-repeat;
  width: 1000px;
  height: 750px;
  position: relative;
}
.aliHead {
  position: absolute;
  width: 200px;
  height: 175px;
  // background-color: #f00;
  top: 25px;
  left: 25px;
  color: #fff;
  overflow: hidden;
}
.copyright {
  position: absolute;
  bottom: 0;
  padding: 0 0 5px 5px;
  color: #888;
}
</style>

</head>
<body>
  <canvas id="cartoonCanvas"></canvas>

  <div class="surface">
    <div class="aliBody" id="aliBody-01"><img src="images/ali_body.png" /></div>
    <div class="aliHead" id="aliHead-01"><img src="images/ali_front_faces.png" /></div>
    <div class="copyright">Images © 2005-2016 Cartoon Solutions</div>
  </div>
  <audio id='audioPlayerId' preload="none" controls>
    <source id="mp3Source" type="audio/mpeg" src="audio/ali_intro.mp3">
    <!-- source id="oggSource" src="http://www.oceansoundscapes.com/audio/ocean/OceanBeach-LandsEndwFogHorn.ogg" type="audio/ogg" -->
    Your browser does not support the audio element.  Please update your browser.
  </audio>

<script>

window.headSprite = null;
window.spriteSheet = null;

// RequestAnimationFrame for Smart Animating
(function() {
  // http://paulirish.com/2011/requestanimationframe-for-smart-animating/
  // http://my.opera.com/emoller/blog/2011/12/20/requestanimationframe-for-smart-er-animating
  // requestAnimationFrame polyfill by Erik Möller. fixes from Paul Irish and Tino Zijdel
  // MIT license

    var lastTime = 0;
    var vendors = ['ms', 'moz', 'webkit', 'o'];
    for(var x = 0; x < vendors.length && !window.requestAnimationFrame; ++x) {
        window.requestAnimationFrame = window[vendors[x]+'RequestAnimationFrame'];
        window.cancelAnimationFrame = window[vendors[x]+'CancelAnimationFrame'] 
                                   || window[vendors[x]+'CancelRequestAnimationFrame'];
    }
 
    if (!window.requestAnimationFrame)
        window.requestAnimationFrame = function(callback, element) {
            var currTime = new Date().getTime();
            var timeToCall = Math.max(0, 16 - (currTime - lastTime));
            var id = window.setTimeout(function() { callback(currTime + timeToCall); }, 
              timeToCall);
            lastTime = currTime + timeToCall;
            return id;
        };
 
    if (!window.cancelAnimationFrame)
        window.cancelAnimationFrame = function(id) {
            clearTimeout(id);
        };
}());


var Sprite = function (options) {

  var that = {},
    frameIndex = 0,
    tickCount = 0,
    ticksPerFrame = options.ticksPerFrame || 0,
    numberOfFrames = options.numberOfFrames || 1;

  that.context = options.context;
  that.width = options.spriteSheetWidth;
  that.height = options.spriteSheetHeight;
  that.image = options.image;
  that.lipsyncData = [ [0,0], [1,0], [2,0], [3,0], [4,0], [5,0], [6,0], [0,0], [1,0], [2,0], [3,0], [4,0], [5,0], [6,0] ];  // !!!!! // options.lipsyncData;
  var lipsyncDataLen = that.lipsyncData.length;


console.log("CHKPT 1: " + options.lipsyncData);
console.log("CHKPT 2: " + that.lipsyncData);

console.log("CHKPT 3: " + options.headWidth);
console.log("CHKPT 4: " + that.headWidth);

  that.update = function () {
    tickCount += 1;

    if (tickCount > ticksPerFrame) {
      tickCount = 0;

      // If the current frame index is in range
      if (frameIndex < numberOfFrames - 1) {  
        // Go to the next frame
        frameIndex += 1;
      } else {
        frameIndex = 0;
      }
    }
  };

  that.render = function () {

    // Clear the canvas
    that.context.clearRect(0, 0, that.width, that.height);

// console.log("HEAD: ", options.lipsyncData[frameIndex][0] + " that.width = " + that.width + " numberOfFrames = " + numberOfFrames);
/// console.log("LOCALS: " + frameIndex + " * " + that.width + "/" + numberOfFrames );
/// console.log("drawImage:: -, " + frameIndex * that.width / numberOfFrames + ", -0-, " + that.width / numberOfFrames + ", " + that.height)

    // Draw the animation
    that.context.drawImage(
      that.image,
      frameIndex * that.width / numberOfFrames,
      0,
      that.width / numberOfFrames,
      that.height,
      0,
      0,
      that.width / numberOfFrames,
      that.height);

  };

  return that;
};


var SpriteMgr = function( initObj ) { 
console.log("SpriteMgr ARRIVAL....", initObj);

  // Get canvas
  this.canvas = document.getElementById("cartoonCanvas");
  this.canvas.width = 200;
  this.canvas.height = 175;
  
  // Create sprite sheet
  this.spriteSheet = new Image();
  
  // Create sprite
  window.headSprite = new Sprite({
    context: this.canvas.getContext("2d"),
    width: 1400,
    height: 700,
    image: this.spriteSheet,
    numberOfFrames: 7,
    ticksPerFrame: 4
  });

  // Load sprite sheet
  this.spriteSheet.addEventListener("load", SpriteMgr.prototype.gameLoop );
  this.spriteSheet.src = "images/ali_front_faces.png";

};

SpriteMgr.prototype.gameLoop = function() {
    window.requestAnimationFrame( SpriteMgr.prototype.gameLoop );

    window.headSprite.update();
    window.headSprite.render();
}


/////////////


var LipSyncManager = function( initObj ) { 
  if (!this.initObj) { this.initObj={}; }

  if (initObj.hasOwnProperty('canvasId')) { this.canvasId = initObj.canvasId;  } 
  else { this.canvasId = this.getDefaults()['canvasId']; }

  if (initObj.hasOwnProperty('spriteSheetFilename')) { this.spriteSheetFilename = initObj.spriteSheetFilename;  } 
  else { this.spriteSheetFilename = this.getDefaults()['spriteSheetFilename']; }

  if (initObj.hasOwnProperty('fps')) { this.fps = initObj.fps;  } 
  else { this.fps = this.getDefaults()['fps']; }

  if (initObj.hasOwnProperty('phonemes')) { this.phonemes = initObj.phonemes;  } 
  else { this.phonemes = this.getDefaults()['phonemes']; }

  if (initObj.hasOwnProperty('headWidth')) { this.headWidth = initObj.headWidth;  } 
  else { this.headWidth = this.getDefaults()['headWidth']; }

  if (initObj.hasOwnProperty('headHeight')) { this.headHeight = initObj.headHeight;  } 
  else { this.headHeight = this.getDefaults()['headHeight']; }

  if (initObj.hasOwnProperty('spriteSheetWidth')) { this.spriteSheetWidth = initObj.spriteSheetWidth;  } 
  else { this.spriteSheetWidth = this.getDefaults()['spriteSheetWidth']; }

  if (initObj.hasOwnProperty('spriteSheetHeight')) { this.spriteSheetHeight = initObj.spriteSheetHeight;  } 
  else { this.spriteSheetHeight = this.getDefaults()['spriteSheetHeight']; }

  if (initObj.hasOwnProperty('expressions')) { this.expressions = initObj.expressions;  } 
  else { this.expressions = this.getDefaults()['expressions']; }

  if (initObj.hasOwnProperty('audioPlayerId')) { 
    this.audioPlayerId = initObj.audioPlayerId; 
  } else { 
    this.audioPlayerId = this.getDefaults()['audioPlayerId'];
  }
  this.audioPlayerElement = document.getElementById( this.audioPlayerId );

  if (initObj.hasOwnProperty('soundFile')) { this.soundFile = initObj.soundFile;  } 
  else { 
    this.soundFile = this.getDefaults()['soundFile']; 
    console.log("LipSyncManager ERROR:  No soundFile specified.  Using default '" + this.soundFile + "'.");
  }

  if (initObj.hasOwnProperty('lipsyncData')) { this.lipsyncData = initObj.lipsyncData;  } 
  else { 
    this.lipsyncData = this.getDefaults()['lipsyncData']; 
    console.log("LipSyncManager ERROR:  No LipsyncData specified.  Using default.");
  }

  if (initObj.hasOwnProperty('headId')) { this.headId = initObj.headId;  } 
  else { 
    this.headId = this.getDefaults()['headId']; 
    console.log("LipSyncManager ERROR:  No headId specified.  Using default '" + this.headId + "'.");
  }
  this.headElement = document.getElementById( this.headId );

  if (initObj.hasOwnProperty('onReady')) { this.onReady = initObj.onReady;  } 
  else { 
    this.onReady = this.getDefaults()['onReady']; 
    console.log("LipSyncManager WARNING:  No 'onReady' function specified.");
  }

  console.log("LipSyncManager::canvasId = " + this.canvasId );
  console.log("LipSyncManager::fps = " + Number(this.fps) );
  console.log("LipSyncManager::phonemes = " + Number(this.phonemes) );
  console.log("LipSyncManager::headWidth = " + Number(this.headWidth) );
  console.log("LipSyncManager::headHeight = " + Number(this.headHeight) );
  console.log("LipSyncManager::expressions = " + Number(this.expressions) );
  console.log("LipSyncManager::audioPlayerId = " + this.audioPlayerId );

  console.log("LipSyncManager::soundFile = " + this.soundFile );
  console.log("LipSyncManager::lipsyncData = " + this.lipsyncData );
  console.log("LipSyncManager::headId = " + this.headId );

  // !!!!! remove - var spriteMgr = new SpriteMgr();

  this.spriteMgr = new SpriteMgr({
    canvasId:  this.canvasId, 
    spriteSheetFilename: this.spriteSheetFilename,
    fps: this.fps,
    phonemes: this.phonemes,
    headWidth: this.headWidth,
    headHeight: this.headHeight,
    spriteSheetWidth: this.spriteSheetWidth,
    spriteSheetHeight: this.spriteSheetHeight,
    expressions: this.expressions,
    headId: this.headId,
    headElement: this.headElement,
    ticksPerFrame: 4,
    lipsyncData: this.lipsyncData
  });

  this.loadAudio(this.soundFile);
  // this.audioPlayerElement.play();

  this.onReady(); //  -- Call this after LIPS and .MP3 have loaded.
};

LipSyncManager.prototype.getDefaults = function() {
  console.log("getDefault arrival.");
  return {
    canvasId: 'cartoonCanvas',
    spriteSheetFilename: 'images/ali_front_faces.png',
    fps: 12,
    phonemes: 6,
    headWidth: 200,
    headHeight: 175,
    spriteSheetWidth: 1400,
    spriteSheetHeight: 700,
    expressions: 1,
    audioPlayerId: 'audioPlayerId',
    soundFile: 'audio/defaultAudio.mp3',
    lipsyncData:  [ [0,2], [1,2], [2,2], [3,2], [4,2], [5,2], [6,2], [0,0], [1,0], [2,0], [3,0], [4,0], [5,0], [6,0] ],
    headId: 'headId',
    onReady: function( cb ) {
      console.log("Default onReady callback!  Will play ASAP.");
      this.play( this.headIdStr );
    }
  }
}

LipSyncManager.prototype.loadAudio = function( anMP3AudioURL ) {
  console.log("MP3 Audio:  " + anMP3AudioURL);
  var anOGGAudioURL = anMP3AudioURL.replace(".mp3", ".ogg"); // Extract .ogg filename

  document.getElementById('mp3Source').src = anMP3AudioURL;
  // document.getElementById('oggSource').src = anOGGAudioURL;

  this.audioPlayerElement.load();
  return true;
};

LipSyncManager.prototype.setSpriteSheetFilename = function( spriteSheetFilename ) { 
  this.setSpriteSheetFilename = spriteSheetFilename;

}

LipSyncManager.prototype.setFrame = function( frameNum, expressionNum ) { 
  console.log("setFrame arrival!!!!!");
  // this.headElement.style["transform"] = "rotate(70deg)";
  // this.headElement.

}

LipSyncManager.prototype.play = function( headIdStr ) { 
    // One headId per soundfile.  We handle only a single headId for now.
    console.log("LipSyncManager::play!");

    this.setFrame( 1, 0 ); // !!!!!

    // setTimeout(  function() { brushTeeth.call(alice) }, 1000); 

    // DISABLED!!!!! this.audioPlayerElement.play(); // Play the HTML element

};

////////////////

var aliBody = document.querySelector("#aliBody-01");
aliBody.style["transform"] = "translateX(300px) translateY(80px)";

var aliHead = document.querySelector("#aliHead-01");
aliHead.style["transform"] = "translateX(360px) translateY(75px)";


var onReadyBeginPlayback = function() {
  console.log( "Custom onReadyBeginPlayback!!!!" );
  this.play("#headIdStr");
}




var lipsMgr = new LipSyncManager( {
  canvasId: 'cartoonCanvas',
  spriteSheetFilename: 'images/ali_front_faces.png',
  fps: 12,
  phonemes: 6,
  headWidth: 200,
  headHeight: 175,
  spriteSheetWidth: 1400,
  spriteSheetHeight: 700,
  expressions: 2,
  audioPlayerId: 'audioPlayerId',
  soundFile: 'audio/ali_intro.mp3',
  lipsyncData:  [ [0,0], [1,0], [2,0], [3,0], [4,0], [5,0], [6,0], [0,0], [1,0], [2,0], [3,0], [4,0], [5,0], [6,0] ],
  headId: 'aliHead-01',
  onReady: onReadyBeginPlayback
} );








</script>

</body>
</html>